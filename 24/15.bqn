text â† â€¢file.Lines "15.in"
cut  â† âŠ‘/0=â‰ Â¨text
map  â†     > cut â†‘ text
cmds â† âˆ¾ (1+cut) â†“ text
dir  â† "v^<>"
Step â† {râ†1+Â¯1âŠ‘/1âˆ¾(âˆ§` (1âŒ¾âŠ‘) ğ•©âˆŠ"O[]")âˆ§'.'=Â«ğ•©â‹„Â¯1âŠ¸âŒ½âŒ¾(râ†‘âŠ¢)ğ•©}
View â† { map ğ•Š c:
  yâ€¿x â† (â‰ âˆ˜âŠ(âŒŠâˆ˜Ã·Ëœâ‹ˆ|)âŠ‘âˆ˜/âˆ˜â¥Š) map = '@'
  f   â† (âŠ‘ dir âŠ c) âŠ‘ âŸ¨xâŠ¸âŠË˜,xâŠ¸âŠË˜,yâŠ¸âŠ,yâŠ¸âŠâŸ©
  g   â† (âŠ‘ dir âŠ c) âŠ‘ âŸ¨yâŠ¸â†“,âŒ½(y+1)âŠ¸â†‘,âŒ½(x+1)âŠ¸â†‘,xâŠ¸â†“âŸ©
  StepâŒ¾GâŒ¾F map
}
p1 â† +Â´âˆ¾1â€¿100Ã—âš‡1 (â‰ map) (|â‹ˆâŒŠâˆ˜Ã·Ëœ)Â¨ /â¥Š 'O' = map ViewËœÂ´ âŒ½cmds
_fix â† {ğ”½âˆ˜âŠ¢âŸâ‰¢âŸœğ”½_ğ•£âˆ˜âŠ¢âŸâ‰¢âŸœğ”½ğ•©}
wide â† {
  wide â† {ğ•Šğ•©: 
    leftâ€¿right â† <Ë˜ 0â€¿1 +âŒœ / (âŠ¢âˆ§Â¬âˆ˜Â») "OO" â· â¥Šğ•©
    ']'Â¨âŒ¾(right âŠ âŠ¢)âŒ¾â¥Š '['Â¨âŒ¾(left âŠ âŠ¢)âŒ¾â¥Š ğ•©
  } _fix â¥Šâ‰2 â‰> 2â¥Š<map
  "@."âŒ¾((0â€¿1+âŠ‘/"@@"â·â¥Šwide)âŠâŠ¢)âŒ¾â¥Š wide
}
WStep â† { 
 map ğ•Š '<': map View '<' ;
 map ğ•Š '>': map View '>' ;
 map ğ•Š c:
  dir â† { c = '^' ? Â¯1â€¿0 ; 1â€¿0 }
  start â† yâ€¿x â† (â‰ âˆ˜âŠ(âŒŠâˆ˜Ã·Ëœâ‹ˆ|)âŠ‘âˆ˜/âˆ˜â¥Š) map = '@'
  swaps â† âŸ¨âŸ©
  surface â† {ğ•Šğ•©:
    # flood-fill forwards along boxes, added adjacent connected boxes
    moves â† (ğ•© âŠ‘ map) âˆŠ "[]@"
    next  â† ((<dir)+Â¨âŠ¢)âŒ¾(movesâŠ¸/) ğ•©
    knock â† next âŠ‘ map
    swaps â†© swaps âˆ¾ < ğ•© â‹ˆÂ¨â—‹(movesâŠ¸/) next
    boxes â† (knock âˆŠ "[]") / next
    left  â† (knock = '[')âŠ¸/ 0â€¿1  +âš‡1 next
    right â† (knock = ']')âŠ¸/ 0â€¿Â¯1 +âš‡1 next
    âˆ§ â· next âˆ¾ left âˆ¾ right
  } _fix â‹ˆ start
  # Compute the bounding box of the changing cells
  minXâ€¿maxX â† x (âŒŠÂ´â‹ˆâŒˆÂ´) 1 âŠ‘Â¨ surface
  minYâ€¿maxY â† y (âŒŠÂ´â‹ˆâŒˆÂ´)   âŠ‘Â¨ surface
  Box â† (<minX + â†•(1+maxX) - minX) âŠË˜ (minY + â†•(1+maxY) - minY) âŠ âŠ¢
  # If the surface is just '.' then the move can happen
  { "." â‰¡ â· surface âŠ‘ map
    ? { ğ•ŠâŸ¨âŸ©: map; ğ•Šğ•©: map âŒ½âŒ¾(ğ•©âŠ‘âŠ¢)â†© }Â¨ âŒ½âˆ¾swaps â‹„ map
    ; map
  }
}
# dbg â† (â†•âˆ˜â‰  âˆ¾Ë˜ âŠ¢) (' 'â€¿wide) âˆ¾ â‰cmds â‰ (<wide) WStep` cmds # pair each state with its index and command
p2 â† +Â´âˆ¾1â€¿100Ã—âš‡1 (â‰ âŠwide) (|â‹ˆâŒŠâˆ˜Ã·Ëœ)Â¨ /â¥Š '[' = wide WStepËœÂ´ âŒ½cmds
